\chapter{Simulation studies for proton computed tomogrophy} \label{sec:setup}
With the demonstration of Corryvreckans validity as a track reconstruction framework, its performance for conditions present
in proton computed tomogrophy scans can be investigated. The telescope used to reconstruct the protons consists of six IBL planar sensors
grouped into two triplets. Due to the fact that the spatial resolution of the sensors are five times better in horizontal direction, the middle sensor
of each triplet is rotated by 90Â°. This way the lower track reconstruction precision in vertical direction is partially compensated for.
The setup for proton computed tomogrophy is shown schematically in figure \ref{fig:phantom} with the phantom inbetween the triplets representing
the patient. \\
For proton computed tomogrophy it is necessary that the protons are able to traverse the entire telescope including the patient
to measure their remaining energy, which is the reason the energy of the proton beam has to be significantly higher than during
the proton therapy. Current proton synchrotrons used in proton therapy centers have an upper energy limit of $200 - \SI{250}{\mega\eV}$.
Therefore, a $\SI{200}{\mega\eV}$ proton beam is used in this analysis.

\begin{figure}
  \centering
  \includegraphics[height=0.45\textwidth]{images/phantom_proton_2.jpg}
  \caption{Schematic representation of the telescope used for the reconstruction of proton computed tomogrophy. The phantom represents the
  patient and is not present in upcoming analysis.}
  \label{fig:phantom}
\end{figure}

Since the tracking performance of Corryvreckan will be investigated, the phantom will not be present in further analysis as it would
increase the number of multiple scatterings and significantly decrease the number of protons passing the telescope. Instead, another
IBL planar sensor placed directly in the middle of the telescope serves as a DUT.

To analyse Corryvreckans performance in reconstructing proton tracks, data feeded into the framework is simulated by the Allpix$^2$ software,
which is explained in the folloing section.

\section{The simulation software Allpix$^2$}
Allpix$^2$ is a generic simulation framework developed at CERN to simulate the performance of silicon detectors and was released in 2017.
It builds upon the
Geant4 \cite{geant4} package to perform tasks in the simulation chain. The main tasks of Allpix$^2$ is the simulation of energy depostions of particles
in the sensors, the propagation of charge carriers in the sensor material and the digitization of the signal. It has a modular
structure to ensure an easy handling, while still allowing for complex detector simulations.
Instantiation and processing of the modules is done by the core of the framework,
which contains five subsystems. This includes the configuration containing the configuration manager, which grants access to the configuration file, the
module subsystem, which loads and executes the modules and the geometry subsystem, which provides the information of the telescope setup.
Objects are transferred from one module to another with the messenger subsystem.
Figure \ref{fig:allpix} depicts the overall structure of Allpix$^2$.

\begin{figure}
  \centering
  \includegraphics[height=0.5\textwidth]{images/allpix.png}
  \caption{Schematic representation of the overall Allpix$^2$ structure. \cite{fig_allpix}.}
  \label{fig:allpix}
\end{figure}

The telescope geometry has to be specified in a geometry file, which includes all sensors and their pixel matrix as well as their spatial and time
resolution. Additionally,
the position and orientation have to be stated. Optionally, uncertainties on the position and orientation can be set to account for misalignment in real
telescope setups.
In the configuration file, the geometry is imported as well as the modules for the simulation in order of execution, which
will be explained in the following.

The world frame of the simulation is created with the GeometryBuilderGeant4 module. The world material can be either air or vacuum with a configurable world margin percentage.
Afterwards all detectors from the internal detector models and passive material models are created according to the specifications in the geometry file.

Charge carriers are deposited in the active volume with the DepositionGeant4 module, which initializes the simulation of particles. The shape of the source beam, as well
as the type of particle and its energy can be specified. Further parameters are the width of the beam, its angular distribution based on a gaussian distribution and the energy
uncertainty of the simulated particles. All particles created at the same time define an event. The number of generated electron hole pairs is calculated with the
mean pair creation energy and is subject to fluctuations, which are defined by the fano factor.

An electric field is added to the sensors with the ElectricFieldReader module. By default all sensors are targeted by the module, though specific sensors can be stated.
There are three types of electric field models available, constant electric fields, linear electric fields and external simulated electric fields, with only
linear electric fiels being used in the scope of this thesis. The constant slope of linear electirc fields are defined by the bias voltage and the
depletion voltage of the sensor. Optionally, the depletion depth instead of the depletion voltage can be specified.

Either with the ProjectionPropagation or the GenericPropagation module the transport of charge carriers through the sensitive material are simulated.
The first module projects electrons or hole onto the surface and performs a randomized diffusion based on a two dimensional gaussian distribution around
the projection. Using an approximation of the drift time makes it possible to determine the diffusion width under the assumption of a linear electric field. This
module save computing time at the cost of accuracy. \\
The GenericPropagation module consists of a combined simulation of diffusion and drift calculated with a Runge-Kutter-Fehlberg method.
It is compatible with any electric field model and can simulate both electrons and holes
at the same time making the module
more accurate at the cost of computing time. The integration time can be specified by the user to determine the time of the propagation process. \\
In both modules, charge carriers are combined to sets and propagated together with no interaction between them. The set size of charge carriers can be specified by the user,
making it possible to control the accuracy and computing time of the simulation. For diffusion simulations it is necessary to specifiy the temperature of the sensor material
to calculate the diffusion constant.

Sets of charges are combined on the sensor pixels with the SimpleTransfer module and are prepared  to be processed by the front-end chips. The
propagated charges are mapped directly to the nearest pixel, while charge carriers that are outside the pixel grid or too far away from the implants are ignored.

Collected charges are then translated into digitised signals proportional to the input charge by the DefaultDigitizer module. Additionally, gaussian noise constributions
from the readout electronics can be simulated and a signal threshold can be defined. The output signal is given in units of the electron charge per default, but
can also be given in bits by simulating a QDC converter. Optionally, a gain factor and gain smearing can be set.

Simulated events and the produced plots of the different modules are stored in a root file. With the ROOTObjectWriter module further information like propagated charge,
deposited charge, Monte Carlo (MC) particle information and pixel hit information are stored in an additional ROOT file. Allpix$^2$ also enables the storing of
data in formats compatible with the EUTelescope and Corryvreckan software with the LCIOWriter module and the CorryvreckanWriter module respectively. Both modules possess parameters, which
determine what information of the Allpix$^2$ simulation is written into the ROOT files.

\section{Simulated setup}
Unlike conditions present in testbeam experiments, protons in pct have a significant lower energy than the $\SI{5}{\giga\eV}$
electron beam produced by DESY II and a higher particle density, creating different and more complex particle tracks for
Corryvreckan to reconstruct. Since Corryvreckans performance in regards to these properties will be investigated, uncertainties
of the sensor position and orientation, as well as the beam energy and direction are set to zero. The simulated
beam has a gaussian profile with a standard deviation of $\SI{3}{\milli\meter}$ and is orientated orthogonal to the sensor
surfaces. All information about the geometry of the telescope is specified in section \ref{sec:setup} with
figure \ref{fig:phantom} depicting the exact positions of the sensors and the beam source. The IBL planar sensor used as a DUT,
instead of a phantom, is positioned at $\SI{10}{\centi\meter}$ along the z-axis. \\
A linear electric field with a bias voltage of $\SI{-100}{\volt}$ and a depletion depth of $\SI{200}{\micro\meter}$,
thus depleting the entire sensor volume, is specified. For the propagation of charge carriers, the more precise generic propagation
module is chosen with a room temperature of $\SI{293}{\kelvin}$ and 300 charges being propagated per step to limit time consumption.\\
A gaussian profile with a default standard deviation of $110$\, e as noise in the electronics is applied in the simulation.
Only pixels with a charge threshold of $600$\, e will trigger a hit.

Simulated data is written out with the CorryvreckanWriter module into a root file having the format to be read
in by Corryvreckan with the FileReader module.

\section{Proton reconstruction}
Before the reconstruction of low energy protons is performed with Corryvreckan, it is crucial to understand how well the
track reconstruction works with protons and the employed telescope, since proton beams are not used in major testbeam
experiments for which Corryvreckan was designed for. Because of that, a simulation containing 50000 protons
with an energy $\SI{100}{\giga\eV}$ is implemented. Particles in this energy region only have small scattering angles, effectively travelling
in straight lines.
No fluctuation in the proton energy is simulated and only one particle traverses
the telescope per event. The residual in x and y direction are shown in figure \ref{fig:100GeV}.

\begin{figure}
  \hspace{-2.5cm}
  %\centering
  \begin{subfigure}{0.62\textwidth}
      \centering
      \includegraphics[height=0.82\textwidth]{plots/100GeV_residualX_tel0.pdf}
  \end{subfigure}
  \begin{subfigure}{0.62\textwidth}
      %\centering
      \hspace{0.95cm}
      \includegraphics[height=0.82\textwidth]{plots/100GeV_residualY_tel0.pdf}
  \end{subfigure}
  \caption{Residual of the first plane in x and y direction shown on the left and right respectively.
  The IBL sensor has a five times larger pixel pitch in x direction. }
  \label{fig:100GeV}
\end{figure}

Especially notable is the five-peak structure of the residual in horizontal direction, which is caused by the different
spatial resolution of subsequent planes. With the horizontal pixel pitch of the non rotated sensors being
five times larger than the other two, the granularity increases by ratio of the different pitches, in this case
$\SI{250}{\micro\meter}/\SI{50}{\micro\meter} = 5$. This effect is shown schematically in figure \ref{fig:peaks}.

\begin{figure}
  \centering
  \includegraphics[height=0.6\textwidth]{images/peaks.png}
  \caption{Occurenace of a five peak residual structure due to a different spatial resolution. The DUT in the middle
  has a five times larger pixel pitch and increases the number of peaks in its residual \cite{peaks}.}
  \label{fig:peaks}
\end{figure}

In the vertical residual of the first plane, only one peak is visible due to the lower spatial resolution, while the rotated planes
in this direction exhibit a five-peak structure. The peaks in the residual a narrow due to the fact that no uncertainties regards
to the sensor positions, sensor inefficiencies or spread in the particles energy is simulated. When taking these into account, the
five peaks broaden to a gaussian profile.
